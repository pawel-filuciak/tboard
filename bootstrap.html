<!DOCTYPE html>
<html lang="en" ng-app="tbApp">
    <head>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
        <style type="text/css">
          .row.reqRow {
            border-bottom: 1px solid #eee;
            margin: 10px;
          }
          .dropArea {
            min-height: 200px;
            border: 2px solid transparent;
            padding: 5px !important;
          }
          .dropArea.active {
            border: 2px dashed #eee;
          }
          .panelWrapper {
            padding: 0px !important;
          }
          .panel {
            margin: 3px !important;
          }
          .panel > .panel-heading {
            height: 35px;
          }
          .panel > .panel-padding {
            padding: 5px 5px !important;
          }
          .panel > .panel-heading.panel-padding {
            padding: 0px 0px !important;
          }
          .panel .link {
            padding-top: 3px;
            padding-left: 3px;
          }
          .panel > .panel-footer.panel-padding {
            padding: 2px 5px !important;
          }
          .panel > .panel-body {
            height: 75px;
            overflow: hidden;
          }
          .panel > .panel-body > small{
            font-size: 10px;
          }          
          .badge-vh {
            background: #D50000;
          }
          .badge-h {
            background: #FF8A80;
          }
          .badge-m {
          }
          .badge-l {
            background: #CFD8DC;
          }
          .badge-vl {
            background: #ECEFF1
          }
          .robot {
            position: absolute;
            top: -4px;
            right: -4px;
          }
        </style>  
    </head>
    <body id="app" ng-controller="boardController">
        <div class="container-fluid">
          <table class="table">
            <caption><h4><a href="/grs/jsf/planning/iteration/edit_iteration.jsf?entityId={{iterationId}}">Sprint {{iterationId}}</a></h4></caption>
            <colgroup>
              <col width="40%"/>
              <col width="40%"/>
              <col width="20%"/>
            </colgroup>
            <tbody>
              <tr ng-repeat="req in reqs">
                <td>
                  <div class="col-sm-12 col-md-12 col-lg-12 panelWrapper" ng-if="req.id != -1">
                    <div class="panel panel-primary">
                      <div class="clearfix">
                        <div class="pull-left link"><a href="/grs/jsf/planning/req/edit_requirement.jsf?entityId={{req.id}}"><small>User Story {{req.id}}</small></a></div>
                      </div>
                      <div class="panel-body panel-padding" >
                        <small class="text-left" title="{{req.name}}">{{req.name}}</small>
                      </div>
                      <div class="panel-footer panel-padding clearfix">
                        <div class="pull-left">
                          
                        </div>
                        <div class="pull-right">
                          <span title="Story Points - {{req.storyPoints}}" class="label label-danger">{{req.storyPoints}}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-12 dropArea" ondrop="columnDrop(event, 'open')" ondragover="columnDragOver(event)">
                    <div class="col-sm-6 col-md-6 col-lg-4 panelWrapper" ng-repeat="task in req.open">
                      <div ng-include src="'inline-taskPanel.html'"></div>
                    </div>
                  </div>                                  
                </td>
                <td>
                  <div class="col-md-12 dropArea" ondrop="columnDrop(event, 'in progress')" ondragover="columnDragOver(event)">
                    <div class="col-sm-6 col-md-6 col-lg-4 panelWrapper" ng-repeat="task in req.inProgress">
                      <div ng-include src="'inline-taskPanel.html'"></div>
                    </div>
                  </div>                  
                </td>
                <td>
                  <div class="col-md-12 dropArea" ondrop="columnDrop(event, 'success')" ondragover="columnDragOver(event)">
                    <div class="col-sm-6 col-md-6 col-lg-6 panelWrapper" ng-repeat="task in req.success">
                      <div ng-include src="'inline-taskPanel.html'"></div>
                    </div>
                  </div>                  
                </td>                                
              </tr>
            </tbody>
          </table>
        </div>
        <!--div class="container-fluid">
            <div class="row reqRow" ng-repeat="req in reqs">
                <div class="col-md-1">
                    <div ng-if="req.id != -1">
                        <h5><a href="/grs/jsf/planning/req/edit_requirement.jsf?entityId={{req.id}}">User Story {{req.id}}</a></h5>
                        <p>{{req.name}}</p>
                    </div>
                </div>
                <div class="col-md-4 dropArea" ondrop="columnDrop(event, 'open')" ondragover="columnDragOver(event)">
                  <div class="col-sm-6 col-md-6 col-lg-4 panelWrapper" ng-repeat="task in req.open">
                    <div ng-include src="'inline-taskPanel.html'"></div>
                  </div>
                </div>                
                <div class="col-md-4 dropArea" ondrop="columnDrop(event, 'in progress')" ondragover="columnDragOver(event)">
                  <div class="col-sm-6 col-md-6 col-lg-4 panelWrapper" ng-repeat="task in req.inProgress">
                    <div ng-include src="'inline-taskPanel.html'"></div>
                  </div>
                </div>
                <div class="col-md-3 dropArea" ondrop="columnDrop(event, 'success')" ondragover="columnDragOver(event)">
                  <div class="col-sm-6 col-md-6 col-lg-4 panelWrapper" ng-repeat="task in req.success">
                    <div ng-include src="'inline-taskPanel.html'"></div>
                  </div>
                </div>
            </div>
        </div-->

        <!-- ng-templates -->
        <script type="text/ng-template" id="inline-taskPanel.html">
          <div class="panel {{getPanelClass(task)}}" style="{{getBgrColor(task)}}" id="task_{{task.id}}" ondragstart="taskDragStart(event)" draggable="true">
            <div class="clearfix">
              <div class="pull-left link"><a href="/grs/jsf/planning/task/edit_task.jsf?entityId={{task.id}}"><small>Task {{task.id}}</small></a></div>
              <div class="pull-right">
                  <div ng-repeat="owner in task.owners" class="robot">
                      <img ng-src="https://robohash.org/{{owner}}?size=35x35" class="face" alt="{{owner}}" title="{{owner}}"/>
                  </div>
              </div>
            </div>
            <div class="panel-body panel-padding" >
              <small class="text-left" title="{{task.name}}">{{task.name}}</small>
            </div>
            <div class="panel-footer panel-padding clearfix">
              <div class="pull-left">
                <div ng-if="task.spinner == true" class="spinner"></div>
                <span title="Priority - {{task.priority}}" class="badge {{getPriorityClass(task)}}">P</span>
              </div>
              <div class="pull-right">
                <span title="Planned Time" class="label label-default" ng-if="isNotClosed(task)">{{task.plannedTime}}</span>
                <span title="Remaining Time" class="label label-primary" ng-if="isNotClosed(task)">{{task.remainingTime}}</span>
              </div>
            </div>
          </div>
        </script>

        <!-- Angular Material Dependencies -->
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

        <!-- Latest compiled and minified JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.6/angular.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.6/angular-animate.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.6/angular-aria.min.js"></script>

        <script type="text/javascript">

            function taskDragStart(ev) {
              ev.dataTransfer.setData("text/html", ev.target.id);
            }
            function columnDragLeave(ev) {
              jQuery(ev.currentTarget).removeClass("active");
            }
            function columnDragOver(ev) {
              ev.preventDefault();
              jQuery(ev.currentTarget).addClass("active");
              ev.currentTarget.addEventListener('dragleave', columnDragLeave, false);
            }

            function columnDrop(ev, newStatus) {
              ev.preventDefault();
              jQuery(ev.currentTarget).removeClass("active");

              var root = angular.element('#app');
              var scope = root.scope();

              var data = ev.dataTransfer.getData("text/html");
              var element = angular.element('#'+ data);
              var task_scope = element.scope();

              var task = task_scope.task;
              if (task.status != newStatus)
              {
                jQuery.get("/grs/api/v1/tasks/" + task.id)
                  .success(function(response) {
                    
                    response.status = newStatus;
                    response.creationDate = null;
                    response.modificationDate = null;
                      jQuery.ajax({
                        url: "/grs/api/v1/tasks/" + task.id,
                        type: 'PUT',
                        data: JSON.stringify(response),
                        dataType: 'json',
                        contentType:"application/json; charset=utf-8",
                        success: function(data)
                        {
                          scope.$apply(function() {
                            task.spinner = false;
                          });
                        }
                    });
                });
                scope.$apply(function() {
                  task.spinner = true;

                  var req = task_scope.$parent.req;
              
                  var list = null;
                  if (task.status == "open") { list = req.open; }
                  if (task.status == "in progress") { list = req.inProgress; }
                  if (task.status == "success") { list = req.success; }
                  if (task.status == "canceled") { list = req.canceled; }

                  var index = list.indexOf(task);
                  if (index >= 0) {
                    list.splice(index, 1);
                  }
            
                  task.status = newStatus;
                
                  if (task.status == "open") { req.open.push(task); }
                  if (task.status == "in progress") { req.inProgress.push(task); }
                  if (task.status == "success") { req.success.push(task); }
                  if (task.status == "canceled") { req.canceled.push(task); }
                });
              }
            }

            var app = angular.module('tbApp', []);
            app.controller('boardController', ['$scope', '$http', function($scope, $http) {
             
                var queryDict = {};
                location.search.substr(1).split("&").forEach(function(item) {queryDict[item.split("=")[0]] = item.split("=")[1]});
                var iterationId = queryDict['iterationId'];
                $scope.iterationId = iterationId;

                $scope.isNotClosed = function(task) { 
                  return jQuery.grep(["open", "in progress"], function(item) {
                    return item == task.status;
                  }).length == 1;
                };

                $scope.getBgrColor = function(task) {
                  switch(task.status) {
                    case "in progress":
                        return "background: #bce8f1";
                    case "success":
                        return "background: #d6e9c6";
                    case "canceled":
                        return "#CCCCCC";
                    default: 
                      return "#FFEB80"; 
                  }
                };

                $scope.getPanelClass = function(task) {
                  switch(task.status) {
                    case "open":
                        return "panel-default";
                    case "in progress":
                        return "panel-info";
                    case "success":
                        return "panel-success";
                    case "canceled":
                        return "panel-warning";
                    default: 
                      return "#FFEB80"; 
                  }
                };

                $scope.getPriorityClass = function(task) {
                  switch(task.priority) {
                    case "Very high":
                        return "badge-vh";
                    case "High":
                        return "badge-h";
                    case "Medium":
                        return "badge-m";
                    case "Low":
                        return "badge-l";
                    case "Very low":
                        return "badge-vl";
                    default: 
                      return "badge-m"; 
                  }
                };

                $http.get("/grs/api/v1/tasks?limit=150&iterationIds=" + iterationId).success( function(response) {             
                    $scope.reqs = [];

                    var noreq = { id: -1, open: [], inProgress: [], success: [], canceled: [] };
                    var anyWithoutReq = false;  
                    var reqIds = "";

                    for(var i = 0; i < response.tasks.length; i++) {
                        var task = response.tasks[i];

                        var req = null;
                    
                        if (task.relation == "requirement") {
                            for(var j = 0; j < $scope.reqs.length; j++) {
                                var r = $scope.reqs[j];
                                if (r.id == task.relationId) {
                                    req = r;    
                                }
                            }
                        } else {
                            req = noreq;
                            anyWithoutReq = true;
                        }
                        if (req == null) {
                            req = { id: task.relationId, name: "(loading)", open: [], inProgress: [], success: [], canceled: [] };
                            $scope.reqs.push(req);
                            reqIds = reqIds + req.id + ",";
                        }
                        if (task.status == "open") { req.open.push(task); }
                        if (task.status == "in progress") { req.inProgress.push(task); }
                        if (task.status == "success") { req.success.push(task); }
                        if (task.status == "canceled") { req.canceled.push(task); }
                    }
                    if (anyWithoutReq) {
                        $scope.reqs.push(noreq);
                    }

                    $http.get("/grs/api/v1/requirements?verbose=false&ids=" + reqIds).success( function(reqResponse) {
                        for(var i = 0; i < $scope.reqs.length; i++) {
                            for(var j = 0; j < reqResponse.requirements.length; j++) {
                                if ($scope.reqs[i].id == reqResponse.requirements[j].id) {
                                    $scope.reqs[i].name = reqResponse.requirements[j].name;
                                    $scope.reqs[i].storyPoints = reqResponse.requirements[j].storyPoints;
                                    $scope.reqs[i].priority = reqResponse.requirements[j].rank;
                                }
                            } 
                        } 
                    });
                });
            }]);
        </script>    
    </body>
</html>